<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>MARFIM TÊXTIL - Controle de Manutenção</title>
    
    <style>
      /* --- 0. ESTILOS GERAIS --- */
      body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 0;
      }
      .container {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
      }
      
      /* --- 1. ESTILOS DA TELA DE LOGIN --- */
      #login-container {
        width: 90%;
        max-width: 400px;
        margin: 50px auto;
        padding: 30px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        text-align: center;
      }
      .login-logo {
        max-width: 250px;
        height: auto;
        margin-bottom: 20px;
      }
      #login-container h2 {
        color: #333;
        margin-bottom: 25px;
      }
      #login-container input {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      #login-container button {
        width: 100%;
        padding: 12px;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      #login-container button:hover {
        background-color: #004a9a;
      }
      #login-error {
        color: red;
        margin-top: 15px;
        font-size: 0.9em;
      }
      
      /* --- 2. ESTILOS DO APP PRINCIPAL (PÓS-LOGIN) --- */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
        background-color: #ffffff;
        border-bottom: 2px solid #eeeeee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .header-logo {
        height: 45px;
        width: auto;
      }
      .header h1 {
        font-size: 1.4em;
        color: #444;
        margin: 0;
        margin-bottom: 2px; /* Adiciona um respiro */
      }
      .title-area {
        text-align: center;
      }
      .app-version {
        font-size: 0.7em; /* Bem pequeno */
        color: #999;     /* Cinza claro */
        font-weight: normal;
      }
      .user-info {
        font-size: 0.9em;
        color: #555;
      }
      
      /* --- 3. ESTILOS DOS FILTROS --- */
      .filters-container {
        padding: 20px;
        background-color: #fafafa;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap; /* Permite que os filtros quebrem a linha em telas pequenas */
        justify-content: space-between;
        align-items: center;
        gap: 15px; /* Espaço entre os itens do filtro */
      }
      .filters-container label {
        font-weight: bold;
        margin-right: 10px;
      }
      .filters-container select {
        padding: 8px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      #print-button {
        padding: 8px 12px;
        font-size: 0.9em;
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: auto; /* Alinha o botão de impressão à direita */
      }
      #print-button:hover {
        background-color: #004a9a;
      }

      /* --- 4. ESTILOS DOS CARDS DE MANUTENÇÃO --- */
      #cards-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .card {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        width: 300px;
        border-left: 10px solid #ccc;
        padding: 20px;
        box-sizing: border-box;
      }
      
      /* CORES DO STATUS */
      .card-vermelho { border-left-color: #d9534f; } /* Vencido */
      .card-amarelo { border-left-color: #f0ad4e; } /* Alerta */
      .card-verde   { border-left-color: #5cb85c; } /* Em Dia */
      .card-realizado {
        border-left-color: #777;
        background-color: #f0f0f0;
      }

      .card h3 {
        margin-top: 0;
        color: #333;
      }
      .card .status-texto {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
      }
      
      /* Cores do texto do status */
      .card-vermelho .status-texto { color: #d9534f; }
      .card-amarelo .status-texto { color: #f0ad4e; }
      .card-verde .status-texto   { color: #5cb85c; }
      .card-realizado .status-texto {
        color: #333;
        font-size: 1.1em;
      }
      
      .card p {
        margin: 5px 0;
        color: #666;
      }
      
      /* Estilo para os Itens Necessários */
      .card-itens {
        font-size: 0.9em;
        font-style: italic;
        color: #333;
        margin-top: 10px;
        padding-top: 5px;
        border-top: 1px dotted #ccc;
      }
      
      /* Detalhes da confirmação */
      .card-confirmation-details {
        font-size: 0.9em;
        color: #111;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px dashed #999;
      }
      .card-confirmation-details p {
        margin: 4px 0;
      }
      
      /* Botões de Ação */
      .card-actions {
        margin-top: 20px;
        text-align: right;
      }
      .card-actions button {
        padding: 10px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }
      .card-actions button:hover {
        background-color: #218838;
      }
      
      /* Botão Desfazer (Supervisão) */
      .card-actions button.btn-desfazer {
        background-color: #f0ad4e;
        margin-right: 10px;
      }
      .card-actions button.btn-desfazer:hover {
        background-color: #ec971f;
      }
      
      /* Mensagens de status */
      #loading-message, #no-data-message {
        width: 100%;
        text-align: center;
        font-size: 1.2em;
        color: #888;
        margin-top: 30px;
      }
      
    </style>
  </head>
  
  <body>
  
    <div id="login-container">
      <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo MARFIM TÊXTIL" class="login-logo">
      <h2>Controle de Manutenção</h2>
      
      <input type="text" id="usuario" placeholder="Usuário">
      <input type="password" id="senha" placeholder="Senha">
      <button onclick="fazerLogin()">Entrar</button>
      
      <div id="login-error" style="display:none;">Usuário ou senha inválidos.</div>
    </div>

    
    <div id="main-app-container" style="display:none;">
    
      <div class="header">
        <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo MARFIM TÊXTIL" class="header-logo">
        
        <div class="title-area">
          <h1>Planejamento de Manutenção</h1>
          <span class="app-version">Autor: Johnny Rodrigues | Versão: 1.0.0</span>
        </div>
        
        <div class="user-info">
          Olá, <span id="user-name"></span>
        </div>
      </div>
      
      <div class="container">
        
        <div class="filters-container">
          
          <div> 
            <label for="filtro-manutencao">Exibir:</label>
            <select id="filtro-manutencao" onchange="carregarCards()">
              <option value="pendentes">Pendentes (Próximos 7 dias)</option>
              <option value="vencidos">Apenas Vencidos</option>
              <option value="prazo">Apenas No Prazo (Verde/Amarelo)</option>
              <option value="realizados">Serviços Realizados</option>
              <option value="todos">Todos (Pendentes + Realizados)</option>
            </select>
          </div>
          
          <div>
            <label for="filtro-maquina">Máquina:</label>
            <select id="filtro-maquina" onchange="carregarCards()">
              <option value="todas">Todas as Máquinas</option>
              </select>
          </div>
          
          <button id="print-button" onclick="abrirImpressao()">Imprimir Relatório</button>
        </div>
        
        <h3>Máquinas</h3>
        <div id="cards-container">
          </div>
      </div>
      
    </div>
    
    <script>
      // Variáveis Globais
      var usuarioLogado = { nome: "", funcao: "" };
      var filtroAtual = "pendentes"; // Mantido por compatibilidade
      var appUrl = ""; // Armazena a URL do App

      /* --- FUNÇÕES DE LOGIN (ATUALIZADAS COM ENCADEAMENTO) --- */
      function fazerLogin() {
        var usuario = document.getElementById("usuario").value;
        var senha = document.getElementById("senha").value;
        var msgErro = document.getElementById("login-error");
        
        if (usuario === "" || senha === "") {
          msgErro.innerHTML = "Por favor, preencha usuário e senha.";
          msgErro.style.display = "block";
          return;
        }
        
        document.querySelector("#login-container button").disabled = true;
        document.querySelector("#login-container button").innerHTML = "Aguarde...";
        
        google.script.run
          .withSuccessHandler(onLoginSuccess)
          .withFailureHandler(onLoginFailure)
          .verificarLogin(usuario, senha);
      }
      
      function onLoginSuccess(resultado) {
        if (resultado.status === "sucesso") {
          usuarioLogado.nome = resultado.nome;
          usuarioLogado.funcao = resultado.funcao;
          
          document.getElementById("login-container").style.display = "none";
          document.getElementById("user-name").innerHTML = usuarioLogado.nome;
          document.getElementById("main-app-container").style.display = "block";
          
          // --- LÓGICA DE CHAMADA ATUALIZADA (ENCADEADA) ---
          
          // 1. Inicia a PRIMEIRA chamada: getAppUrl
          console.log("Iniciando chamada 1: getAppUrl");
          google.script.run
            .withSuccessHandler(onGetUrlSuccess) // Chama a próxima etapa
            .getAppUrl();
          
        } else {
          onLoginFailure(resultado.mensagem);
        }
      }

      function onLoginFailure(erro) {
        var msgErro = document.getElementById("login-error");
        msgErro.innerHTML = erro;
        msgErro.style.display = "block";
        document.querySelector("#login-container button").disabled = false;
        document.querySelector("#login-container button").innerHTML = "Entrar";
      }

      /* --- NOVA FUNÇÃO DE ENCADEAMENTO (ETAPA 1) --- */
      function onGetUrlSuccess(url) {
        appUrl = url;
        console.log("URL do App:", appUrl);
        
        // 2. Inicia a SEGUNDA chamada: getListaDeMaquinas
        console.log("Iniciando chamada 2: getListaDeMaquinas");
        google.script.run
          .withSuccessHandler(populateMachineFilter) // Chama a próxima etapa
          .withFailureHandler(onPopulateMachineFailure) // Adiciona um tratador de falhas
          .getListaDeMaquinas();
      }

      /* --- ATUALIZADA: Preenche o filtro e chama a próxima etapa (ETAPA 2) --- */
      function populateMachineFilter(listaMaquinas) {
        var select = document.getElementById("filtro-maquina");
        
        if (listaMaquinas && listaMaquinas.length > 0) {
          // Ordena alfabeticamente
          listaMaquinas.sort(); 
          
          listaMaquinas.forEach(function(nomeMaquina) {
            var option = document.createElement("option");
            option.value = nomeMaquina;
            option.text = nomeMaquina;
            select.appendChild(option);
          });
          console.log("Filtro de máquinas populado com " + listaMaquinas.length + " itens.");
        } else {
           console.log("Nenhuma máquina encontrada para popular o filtro.");
        }
        
        // 3. Inicia a TERCEIRA (e última) chamada: carregarCards()
        // Isso só acontece DEPOIS que as duas primeiras terminaram.
        console.log("Iniciando chamada 3: carregarCards");
        carregarCards();
      }

      /* --- NOVA FUNÇÃO DE TRATAMENTO DE ERRO --- */
      function onPopulateMachineFailure(erro) {
         console.error("Falha GRAVE ao buscar lista de máquinas: ", erro);
         alert("Não foi possível carregar a lista de máquinas. O aplicativo pode não funcionar corretamente.");
         
         // Mesmo com a falha, tentamos carregar os cards
         carregarCards();
       }
      
      /* --- FUNÇÕES DE CARREGAMENTO DE CARDS (ATUALIZADA) --- */
      
      function carregarCards() {
        // Lê AMBOS os filtros
        var filtroStatus = document.getElementById("filtro-manutencao").value;
        var filtroMaquina = document.getElementById("filtro-maquina").value; // <-- NOVA LINHA
        
        // Atualiza a variável global (apenas para compatibilidade, se usada em outro lugar)
        filtroAtual = filtroStatus; 

        var container = document.getElementById("cards-container");
        container.innerHTML = '<div id="loading-message">Carregando manutenções...</div>';

        // Se o filtro for "realizados", busca do histórico
        if (filtroStatus === 'realizados') {
          google.script.run
            .withSuccessHandler(onCardsLoaded)
            .withFailureHandler(onCardsLoadFailure)
            .buscarDadosHistorico(filtroMaquina);
        } else {
          // Para os demais filtros, busca da aba Máquinas
          google.script.run
            .withSuccessHandler(onCardsLoaded)
            .withFailureHandler(onCardsLoadFailure)
            .buscarDadosManutencaoComFiltro(filtroStatus, filtroMaquina);
        }
      }
      
      function onCardsLoaded(dadosMaquinas) {
        var container = document.getElementById("cards-container");
        container.innerHTML = ""; 

        var mensagemFiltro = document.getElementById("filtro-manutencao").options[document.getElementById("filtro-manutencao").selectedIndex].text;
        
        // CORREÇÃO: Verifica se dadosMaquinas é null (erro de servidor)
        if (dadosMaquinas == null) {
          onCardsLoadFailure("O servidor retornou um erro inesperado (null).");
          return;
        }
        
        if (dadosMaquinas.length === 0) {
          container.innerHTML = '<div id="no-data-message">Nenhum item encontrado para os filtros selecionados.</div>';
          return;
        }
        
        dadosMaquinas.forEach(function(maquina) {
          
          var cardClasse = "";
          if (maquina.status === "Vencido") cardClasse = "card-vermelho";
          if (maquina.status === "Alerta") cardClasse = "card-amarelo";
          if (maquina.status === "Em Dia") cardClasse = "card-verde";
          if (maquina.status === "Realizado") cardClasse = "card-realizado";
          
          var detailsHtml = "";
          var botoesHtml = "";
          
          // O identificador é o novo campo que combina Máquina|Itens
          // IMPORTANTE: Esta lógica foi revertida para a anterior (nomeMaquina)
          // porque o seu código não estava mais usando o 'identificador'.
          // Se o seu Code.gs AINDA usa 'identificador', você precisa mudar aqui.
          var nomeMaquinaParaAcao = maquina.maquina; 
          
          if (maquina.tipo === "Realizado") {
            detailsHtml = 
              '<div class="card-confirmation-details">' +
                '<p><strong>Realizado por:</strong> ' + maquina.realizadoPor + '</p>' +
                '<p><strong>Em:</strong> ' + maquina.dataConfirmacaoFormatada + '</p>' +
              '</div>';
          }

          var podeRealizar = usuarioLogado.funcao === "Mecanico" || usuarioLogado.funcao === "Supervisao";
          var podeDesfazer = usuarioLogado.funcao === "Supervisao";
          
          // *** Verifique esta lógica ***
          // O código que você colou da última vez usava 'identificador'
          // Mas o código anterior (e este limpo) usa 'maquina.maquina'
          // Vamos usar a versão da última vez, pois parecia ser a sua correção
          
          var identificador = maquina.maquina; // Esta linha foi adaptada da sua última versão.
          // Se o seu Code.gs foi modificado para 'maquina.identificador', mude esta linha para:
          // var identificador = maquina.identificador;
          
          // Se o seu `Code.gs` espera `identificador`, o objeto `maquina` 
          // DEVE ter a propriedade `maquina.identificador`.
          // Se não tiver, use `maquina.maquina`.
          
          // Vou usar a lógica que você me mostrou da última vez,
          // que parecia estar esperando um 'identificador'
          
          // Esta é a sua lógica de `identificador` da última vez
          if (maquina.identificador) {
             identificador = maquina.identificador;
          } else {
             // Plano B se 'identificador' não veio do servidor
             identificador = maquina.maquina; 
          }


          // Não mostra botões se for um item arquivado (do histórico)
          if (!maquina.arquivado) {
            if (maquina.tipo === "Pendente" && podeRealizar) {
              // Passamos o IDENTIFICADOR para a função
              botoesHtml = '<button onclick="cliqueRegistrarManutencao(this, \'' + identificador + '\')">Manutenção Realizada</button>';
            }
            else if (maquina.tipo === "Realizado" && podeDesfazer) {
              // Passamos o IDENTIFICADOR para a função
              botoesHtml = '<button class="btn-desfazer" onclick="cliqueDesfazerManutencao(this, \'' + identificador + '\')">Desfazer</button>' +
                           '<button onclick="cliqueRegistrarManutencao(this, \'' + identificador + '\')">Registrar Novamente</button>';
            }
          }

          var cardHtml = 
            '<div class="card ' + cardClasse + '">' +
              '<h3>' + maquina.maquina + '</h3>' +
              '<p class="status-texto">' + maquina.statusTexto + '</p>' +
              (maquina.tipo === "Pendente" ? '<p><strong>Próxima Manutenção:</strong> ' + maquina.proximaData + '</p>' : '') +
              '<p><strong>Intervalo:</strong> ' + maquina.intervalo + '</p>' +
              
              '<p class="card-itens"><strong>Itens:</strong> ' + maquina.itens + '</p>' +
              
              detailsHtml +
              '<div class="card-actions">' + botoesHtml + '</div>' +
            '</div>';
            
          container.innerHTML += cardHtml;
        });
      }
      
      function onCardsLoadFailure(erro) {
        var container = document.getElementById("cards-container");
        container.innerHTML = '<div id="no-data-message">Erro ao carregar dados. Tente recarregar. (' + erro + ')</div>';
      }
      
      /* --- FUNÇÕES DE AÇÃO (Usando a lógica de enviar filtros) --- */

      function cliqueRegistrarManutencao(botao, identificador) {
        botao.disabled = true;
        botao.innerHTML = "Salvando...";
        
        var filtroStatus = document.getElementById("filtro-manutencao").value;
        var filtroMaquina = document.getElementById("filtro-maquina").value;
        
        google.script.run
          .withSuccessHandler(onManutencaoSuccess)
          .withFailureHandler(function(err) { onManutencaoFailure(err, botao); })
          .registrarManutencao(identificador, usuarioLogado.nome, filtroStatus, filtroMaquina);
      }

      function onManutencaoSuccess(resultado) {
        
        if (resultado && resultado.status === "sucesso") {
          console.log("Servidor retornou SUCESSO com dados atualizados.");
          // --- MUDANÇA: Renderiza os dados recebidos ---
          onCardsLoaded(resultado.dados);
        } else {
          var msgErro = (resultado ? resultado.mensagem : "Resposta nula ou inesperada do servidor.");
          console.error("Servidor retornou um erro:", msgErro);
          alert("Falha ao registrar: \n" + msgErro);
          carregarCards(); 
        }
      }
      
      function onManutencaoFailure(erro, botao) {
        var mensagem = "Falha grave de comunicação: " + (erro.message || "Erro desconhecido.");
        console.error(mensagem);
        alert(mensagem); 
        
        if (botao) {
          botao.disabled = false;
          botao.innerHTML = "Tentar Novamente";
        } else {
          carregarCards();
        }
      }

      /* --- FUNÇÕES: DESFAZER (Usando a lógica de enviar filtros) --- */
      
      function cliqueDesfazerManutencao(botao, identificador) {
        // Usa o 'identificador' para o confirm
        var nomeMaquina = identificador.split('|')[0];
        if (!confirm("Tem certeza que deseja reabrir esta manutenção?\n\nMáquina: " + nomeMaquina)) {
          return;
        }
        
        botao.disabled = true;
        botao.innerHTML = "Desfazendo...";
        
        var filtroStatus = document.getElementById("filtro-manutencao").value;
        var filtroMaquina = document.getElementById("filtro-maquina").value;
        
        google.script.run
          .withSuccessHandler(onDesfazerSuccess) 
          .withFailureHandler(function(err) { onDesfazerFailure(err, botao); })
          .desfazerManutencao(identificador, filtroStatus, filtroMaquina);
      }
      
      function onDesfazerSuccess(resultado) {
        if (resultado && resultado.status === "sucesso") {
          console.log("Manutenção desfeita. Servidor retornou dados atualizados.");
          // --- MUDANÇA: Renderiza os dados recebidos ---
          onCardsLoaded(resultado.dados);
        } else {
          var msgErro = (resultado ? resultado.mensagem : "Resposta nula ou inesperada do servidor.");
          console.error("Servidor retornou um erro:", msgErro);
          alert("Falha ao desfazer: \n" + msgErro);
          carregarCards(); 
        }
      }
      
      function onDesfazerFailure(erro, botao) {
         var mensagem = "Falha grave de comunicação: " + (erro.message || "Erro desconhecido.");
        console.error(mensagem);
        alert(mensagem);
        
        if (botao) {
          botao.disabled = false;
          botao.innerHTML = "Desfazer";
        } else {
          carregarCards();
        }
      }

      /* --- FUNÇÃO: IMPRESSÃO (Sem mudanças) --- */
      
      function abrirImpressao() {
        if (appUrl === "") {
          alert("Aguarde, a aplicação ainda está carregando. Tente novamente em 2 segundos.");
          return;
        }
        
        var filtroSelect = document.getElementById("filtro-manutencao");
        var filtroValor = filtroSelect.value;
        var filtroNome = filtroSelect.options[filtroSelect.selectedIndex].text;
        
        var filtroMaquinaSelect = document.getElementById("filtro-maquina"); 
        var filtroMaquinaValor = filtroMaquinaSelect.value; 
        
        var url = appUrl + "?page=print" + 
                     "&filtro=" + filtroValor + 
                     "&filtroMaquina=" + encodeURIComponent(filtroMaquinaValor) + 
                     "&filtroNome=" + encodeURIComponent(filtroNome);
        
        console.log("Abrindo URL de impressão: " + url);
        window.open(url, '_blank');
      }

    </script>
  </body>
</html>
